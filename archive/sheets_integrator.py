"""
Integrador Biscoit√£o - Google Sheets para PDF
Sistema que processa consultas do Sheets e gera PDFs automaticamente
"""

import sys
import os
import json
from datetime import datetime
from pdf_report_generator import ProfessionalPDFReportGenerator
import requests
import time

class BiscoitaoSheetsIntegrator:
    """Integrador entre Google Sheets e sistema de relat√≥rios PDF"""
    
    def __init__(self):
        self.pdf_generator = ProfessionalPDFReportGenerator()
        self.toqan_api_url = "https://api.toqan.ai"  # URL base da API Toqan
        self.conversation_storage = {}  # Armazena conversa√ß√µes ativas
    
    def process_sheets_query(self, user_query, conversation_id=None):
        """Processa consulta vinda do Google Sheets e gera PDF"""
        
        print(f"üìä BISCOIT√ÉO SHEETS INTEGRATOR")
        print("=" * 50)
        print(f"üîç Consulta: {user_query}")
        print(f"üÜî Conversation ID: {conversation_id}")
        print()
        
        try:
            # 1. Gera relat√≥rio PDF completo
            print("üìÑ Gerando relat√≥rio PDF...")
            result = self.pdf_generator.generate_professional_pdf_report(user_query)
            
            if not result:
                return {
                    'success': False,
                    'error': 'N√£o foi poss√≠vel gerar relat√≥rio para esta consulta',
                    'timestamp': datetime.now().isoformat()
                }
            
            # 2. Prepara resposta para o Sheets
            response_data = {
                'success': True,
                'query': user_query,
                'timestamp': result['timestamp'],
                'files': {
                    'pdf': result['pdf_file'],
                    'markdown': result['markdown_file'],
                    'chart': result['chart_file']
                },
                'analysis': {
                    'insights': result['analysis_result']['insights'],
                    'summary': result['analysis_result']['response'],
                    'data_points': len(result['analysis_result']['data']),
                    'viz_type': result['analysis_result']['viz_type']
                },
                'download_info': self._generate_download_info(result),
                'conversation_id': conversation_id
            }
            
            # 3. Armazena na conversa (se houver ID)
            if conversation_id:
                self.conversation_storage[conversation_id] = response_data
            
            print("‚úÖ Processamento conclu√≠do!")
            return response_data
            
        except Exception as e:
            print(f"‚ùå Erro no processamento: {e}")
            return {
                'success': False,
                'error': str(e),
                'timestamp': datetime.now().isoformat(),
                'conversation_id': conversation_id
            }
    
    def _generate_download_info(self, result):
        """Gera informa√ß√µes de download para o Sheets"""
        
        download_info = {
            'pdf_path': os.path.abspath(result['pdf_file']) if result['pdf_file'] else None,
            'pdf_size': None,
            'markdown_path': os.path.abspath(result['markdown_file']),
            'chart_path': os.path.abspath(result['chart_file'])
        }
        
        # Calcula tamanho do PDF se existe
        if result['pdf_file'] and os.path.exists(result['pdf_file']):
            download_info['pdf_size'] = os.path.getsize(result['pdf_file'])
        
        return download_info
    
    def create_toqan_conversation(self, user_query):
        """Cria nova conversa√ß√£o na API Toqan (simula√ß√£o)"""
        
        # Implementa√ß√£o simulada - ajustar conforme API real
        conversation_data = {
            'pergunta': user_query,
            'timestamp': datetime.now().isoformat(),
            'fonte': 'biscoitao_sheets',
            'tipo': 'relatorio_pdf'
        }
        
        # Aqui seria a chamada real para API Toqan
        # response = requests.post(f"{self.toqan_api_url}/conversation", 
        #                         json=conversation_data)
        
        # Por enquanto, retorna ID simulado
        conversation_id = f"conv_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        return {
            'conversation_id': conversation_id,
            'status': 'created',
            'data': conversation_data
        }
    
    def get_conversation_response(self, conversation_id):
        """Obt√©m resposta de uma conversa√ß√£o"""
        
        if conversation_id in self.conversation_storage:
            return self.conversation_storage[conversation_id]
        else:
            return {
                'success': False,
                'error': 'Conversa√ß√£o n√£o encontrada',
                'conversation_id': conversation_id
            }
    
    def format_sheets_response(self, response_data):
        """Formata resposta para exibi√ß√£o no Google Sheets"""
        
        if not response_data['success']:
            return f"‚ùå Erro: {response_data['error']}"
        
        # Monta resposta formatada para o Sheets
        formatted_response = f"""üìä RELAT√ìRIO BISCOIT√ÉO GERADO

üîç Consulta: {response_data['query']}
‚è∞ Gerado em: {datetime.fromisoformat(response_data['timestamp']).strftime('%d/%m/%Y %H:%M:%S')}

üìà Resultados:
‚Ä¢ {response_data['analysis']['data_points']} registros analisados
‚Ä¢ Tipo: {response_data['analysis']['viz_type'].replace('_', ' ').title()}

üí° Principais Insights:"""
        
        for insight in response_data['analysis']['insights'][:3]:  # Top 3 insights
            # Remove emojis para melhor exibi√ß√£o no Sheets
            clean_insight = insight[2:].strip() if insight.startswith(('üìà', 'üìâ', 'üìä', 'üîù', 'üîª', '‚ö†Ô∏è', 'ü•á')) else insight
            formatted_response += f"\n‚Ä¢ {clean_insight}"
        
        formatted_response += f"""

üìÑ Arquivos Gerados:
‚Ä¢ PDF: {response_data['files']['pdf'] if response_data['files']['pdf'] else 'N√£o dispon√≠vel'}
‚Ä¢ Markdown: {response_data['files']['markdown']}
‚Ä¢ Gr√°fico: {response_data['files']['chart']}

üí¨ Resumo: {response_data['analysis']['summary']}

üîó ID da Conversa√ß√£o: {response_data['conversation_id']}
"""
        
        return formatted_response

def create_updated_google_apps_script():
    """Cria vers√£o atualizada do Google Apps Script para integra√ß√£o"""
    
    apps_script_code = '''
/**
 * Biscoit√£o - Fun√ß√£o Atualizada para Integra√ß√£o com PDF
 * Vers√£o 2.0 - Integrada com gera√ß√£o de relat√≥rios PDF
 */

function perguntarToqan(pergunta) {
  console.log("üöÄ Iniciando pergunta para Biscoit√£o:", pergunta);
  
  try {
    // 1. Cria nova conversa√ß√£o
    const conversationResponse = criarConversacaoBiscoitao(pergunta);
    
    if (!conversationResponse.success) {
      return `‚ùå Erro ao criar conversa√ß√£o: ${conversationResponse.error}`;
    }
    
    console.log("‚úÖ Conversa√ß√£o criada:", conversationResponse.conversation_id);
    
    // 2. Processa consulta e gera PDF
    const processResponse = processarConsultaBiscoitao(pergunta, conversationResponse.conversation_id);
    
    if (!processResponse.success) {
      return `‚ùå Erro no processamento: ${processResponse.error}`;
    }
    
    // 3. Formata resposta para exibi√ß√£o
    const formattedResponse = formatarRespostaBiscoitao(processResponse);
    
    // 4. Abre PDF em nova aba (se dispon√≠vel)
    if (processResponse.files && processResponse.files.pdf) {
      abrirPDFEmNovaAba(processResponse.files.pdf, processResponse.timestamp);
    }
    
    console.log("üéØ Processamento conclu√≠do com sucesso");
    return formattedResponse;
    
  } catch (error) {
    console.error("‚ùå Erro na fun√ß√£o perguntarToqan:", error);
    return `‚ùå Erro interno: ${error.message}`;
  }
}

function criarConversacaoBiscoitao(pergunta) {
  /**
   * Cria nova conversa√ß√£o no sistema Biscoit√£o
   */
  
  try {
    // URL do servidor Biscoit√£o (ajustar conforme necess√°rio)
    const biscoitaoUrl = "http://localhost:5000/api/create-conversation";
    
    const payload = {
      'pergunta': pergunta,
      'fonte': 'google_sheets',
      'timestamp': new Date().toISOString()
    };
    
    const options = {
      'method': 'POST',
      'headers': {
        'Content-Type': 'application/json'
      },
      'payload': JSON.stringify(payload)
    };
    
    // Simula√ß√£o - em produ√ß√£o fazer chamada real
    // const response = UrlFetchApp.fetch(biscoitaoUrl, options);
    // const data = JSON.parse(response.getContentText());
    
    // Por enquanto, retorna dados simulados
    const conversationId = `conv_${new Date().getTime()}`;
    
    return {
      'success': true,
      'conversation_id': conversationId,
      'status': 'created'
    };
    
  } catch (error) {
    console.error("Erro ao criar conversa√ß√£o:", error);
    return {
      'success': false,
      'error': error.message
    };
  }
}

function processarConsultaBiscoitao(pergunta, conversationId) {
  /**
   * Processa consulta e gera relat√≥rio PDF
   */
  
  try {
    // URL do processador Biscoit√£o
    const processUrl = "http://localhost:5000/api/process-query";
    
    const payload = {
      'query': pergunta,
      'conversation_id': conversationId,
      'output_format': 'pdf',
      'timestamp': new Date().toISOString()
    };
    
    const options = {
      'method': 'POST',
      'headers': {
        'Content-Type': 'application/json'
      },
      'payload': JSON.stringify(payload)
    };
    
    // Chamada real seria:
    // const response = UrlFetchApp.fetch(processUrl, options);
    // const data = JSON.parse(response.getContentText());
    
    // Simula√ß√£o de resposta
    const timestamp = new Date().getTime();
    
    return {
      'success': true,
      'query': pergunta,
      'timestamp': timestamp,
      'files': {
        'pdf': `relatorio_biscoitao_${timestamp}.pdf`,
        'markdown': `relatorio_biscoitao_${timestamp}.md`,
        'chart': `chart_line_chart_${timestamp}.png`
      },
      'analysis': {
        'insights': [
          'üìà Tend√™ncia de crescimento detectada',
          'üìä An√°lise temporal conclu√≠da',
          'üîç Insights autom√°ticos gerados'
        ],
        'summary': 'An√°lise completa realizada com sucesso.',
        'data_points': 148,
        'viz_type': 'line_chart'
      },
      'conversation_id': conversationId
    };
    
  } catch (error) {
    console.error("Erro no processamento:", error);
    return {
      'success': false,
      'error': error.message,
      'conversation_id': conversationId
    };
  }
}

function formatarRespostaBiscoitao(responseData) {
  /**
   * Formata resposta para exibi√ß√£o no Google Sheets
   */
  
  if (!responseData.success) {
    return `‚ùå Erro: ${responseData.error}`;
  }
  
  const timestamp = new Date(responseData.timestamp).toLocaleString('pt-BR');
  
  let formatted = `üìä RELAT√ìRIO BISCOIT√ÉO GERADO\\n\\n`;
  formatted += `üîç Consulta: ${responseData.query}\\n`;
  formatted += `‚è∞ Gerado em: ${timestamp}\\n\\n`;
  
  formatted += `üìà Resultados:\\n`;
  formatted += `‚Ä¢ ${responseData.analysis.data_points} registros analisados\\n`;
  formatted += `‚Ä¢ Tipo: ${responseData.analysis.viz_type.replace('_', ' ')}\\n\\n`;
  
  formatted += `üí° Principais Insights:\\n`;
  responseData.analysis.insights.slice(0, 3).forEach(insight => {
    const cleanInsight = insight.replace(/[üìàüìâüìäüîùüîª‚ö†Ô∏èü•á]/g, '').trim();
    formatted += `‚Ä¢ ${cleanInsight}\\n`;
  });
  
  formatted += `\\nüìÑ Arquivos Gerados:\\n`;
  formatted += `‚Ä¢ PDF: ${responseData.files.pdf}\\n`;
  formatted += `‚Ä¢ Markdown: ${responseData.files.markdown}\\n`;
  formatted += `‚Ä¢ Gr√°fico: ${responseData.files.chart}\\n\\n`;
  
  formatted += `üí¨ Resumo: ${responseData.analysis.summary}\\n\\n`;
  formatted += `üîó ID: ${responseData.conversation_id}`;
  
  return formatted;
}

function abrirPDFEmNovaAba(pdfFile, timestamp) {
  /**
   * Abre PDF em nova aba (implementa√ß√£o dependente do ambiente)
   */
  
  try {
    // Em ambiente real, seria necess√°rio criar URL de download
    // ou integra√ß√£o com Google Drive para abrir o PDF
    
    console.log(`üìñ PDF pronto para abertura: ${pdfFile}`);
    console.log(`üïê Timestamp: ${timestamp}`);
    
    // Implementa√ß√£o futura: upload para Google Drive e abertura
    // const driveFile = DriveApp.createFile(pdfBlob);
    // const fileUrl = driveFile.getUrl();
    // HtmlService.createHtmlOutput(`<script>window.open('${fileUrl}', '_blank');</script>`);
    
  } catch (error) {
    console.error("Erro ao abrir PDF:", error);
  }
}

// Fun√ß√£o auxiliar para teste
function testarBiscoitao() {
  const resultado = perguntarToqan("Evolu√ß√£o do pre√ßo m√©dio de jan-24 a jan-25");
  console.log("Resultado do teste:", resultado);
  return resultado;
}
'''
    
    return apps_script_code

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("üîß BISCOIT√ÉO SHEETS INTEGRATOR")
        print("=" * 40)
        print("Uso: python sheets_integrator.py 'sua consulta'")
        print()
        print("Exemplos:")
        print("  python sheets_integrator.py 'Evolu√ß√£o do pre√ßo de jan-24 a jan-25'")
        print("  python sheets_integrator.py 'Compare categorias por volume'")
        print()
        print("üìÑ Para gerar Google Apps Script atualizado:")
        print("  python sheets_integrator.py --generate-script")
        
        if "--generate-script" in sys.argv:
            print("\nüìù Gerando Google Apps Script atualizado...")
            script_code = create_updated_google_apps_script()
            
            with open("biscoitao_sheets_v2.gs", "w", encoding="utf-8") as f:
                f.write(script_code)
            
            print("‚úÖ Arquivo gerado: biscoitao_sheets_v2.gs")
            print("üìã Copie este c√≥digo para o Google Apps Script")
        
        sys.exit(1)
    
    # Processa consulta diretamente
    query = " ".join(sys.argv[1:])
    
    try:
        integrator = BiscoitaoSheetsIntegrator()
        
        # Simula chamada do Sheets
        conversation = integrator.create_toqan_conversation(query)
        result = integrator.process_sheets_query(query, conversation['conversation_id'])
        
        if result['success']:
            print("\n" + "="*60)
            print("üì± RESPOSTA FORMATADA PARA GOOGLE SHEETS:")
            print("="*60)
            print(integrator.format_sheets_response(result))
            print("="*60)
        else:
            print(f"\n‚ùå Erro: {result['error']}")
    
    except Exception as e:
        print(f"‚ùå Erro no integrador: {e}")
        import traceback
        traceback.print_exc()
